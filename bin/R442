#!/bin/bash

source /data/cqs/softwares/cqsperl/scripts/binds.sh

rimg=/data/cqs/softwares/singularity/cqs_bioconductor_3_21_r451.20250908.sif

rver=$(singularity exec -e -B $mybinds $rimg R --version | awk 'NR==1{match($3, /^[0-9]+\.[0-9]+/, v); print v[0]}')

myhost=$(echo $HOSTNAME | cut -d'.' -f1)

if [[ $myhost == cqs* ]]; then #from gateway
  echo "from gateway, $myhost"
fi

if [[ $myhost == cn* ]]; then #from slurm node
  myhost="cqs4"
  echo "from slurm node, use cqs4"
fi

rlib="/nobackup/h_cqs/rlibs_${rver}_${myhost}/$USER"

#echo DISPLAY=$DISPLAY

if( [ ! -d $rlib ] ) 
then
  mkdir -p $rlib
fi

#Using -c to exclude a lot of folders might cause problem for writing temp files.
singularity exec -e -B $mybinds --pwd $(pwd) \
  --env R_LIBS="$rlib" \
  --env TZ="America/Chicago" \
  $rimg \
  R "$@"
