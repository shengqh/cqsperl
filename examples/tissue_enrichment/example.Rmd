---
title: "Target Gene Enrichment Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
 rmdformats::readthedown:
    toc_depth: 3
    code_folding: hide
---

```{r,eval=FALSE,echo=FALSE}
library(xfun)
root_dir = '/nobackup/h_cqs/shengq2/temp/tissue_enrichment_report'
dir.create(root_dir, showWarnings=FALSE)

setwd(root_dir)

file.copy("/nobackup/h_cqs/shengq2/program/cqsperl/examples/tissue_enrichment/example.Rmd", "./", overwrite=TRUE)
file.copy("/nobackup/h_cqs/shengq2/program/cqsperl/examples/tissue_enrichment/tissue_enrichment.Rmd", "./", overwrite=TRUE)

date_str = format(Sys.time(), "%Y%m%d")

xfun::Rscript_call(
  rmarkdown::render,
  list(input="example.Rmd",
       output_file=paste0(date_str, "_example.html"))
)
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
root_dir = '/nobackup/h_cqs/shengq2/temp/tissue_enrichment_report'

library(knitr)
library(data.table)
library(dplyr)

knitr::opts_chunk$set(
  include=TRUE, 
  echo=FALSE, 
  warning=FALSE, 
  message=FALSE, 
  results="asis"
)

date_str = format(Sys.time(), "%Y%m%d")

knitr::opts_knit$set(root.dir = root_dir)
setwd(root_dir)
```

```{r include=FALSE}
#set up those variables in main RMD file
code_folder="/nobackup/h_cqs/jstolze/General_scripts/TissueExpression_combined/Functions"
prefix="test"

gene_exp_file = "/nobackup/h_cqs/references/tissue_specific/20230627_tabula_logNorm_averageExpression_matrix_by_tissueOnly.txt.gz"
proteinAtlasDatabaseFile = "/nobackup/h_cqs/references/tissue_specific/proteinatlas.tsv.zip"

pathway_analysis_sets = c("KEGG", "Reactome", "WikiPathways")

fromType = "SYMBOL" #target and background genes
toType = "ENTREZID" #pathway analysis db ids
#organism="mmu"
#OrgDb="org.Mm.eg.db"
organism="hsa"
OrgDb="org.Hs.eg.db"

database_gene = "ENSEMBL" #What gene annotation is in the gene_exp file
xaxis_enrichment = "" #If string, will pull column of that name from target/background
colNameGenes = "EntrezGeneSymbol"
singDirection = ""

perform_pathway = F

perform_tissue_specificity = T

perform_gene_exp_heatmap = T
perform_gene_exp_5perc = T
perform_gene_exp_enrichment = F
perform_singscore = F
```

# Top 500 genes

```{r, eval=TRUE}
rnk_file="/nobackup/h_cqs/shengq2/program/cqsperl/data/Cardiomyocyte.AS_vs_Control_GSEA.rnk"
background_genes=fread(rnk_file)$V1
target_genes=background_genes[1:500]
```

```{r child="tissue_enrichment.Rmd", eval=TRUE}
```

```{r, eval=FALSE}
cat("\n\n# Bottom 500\n\n")
background_genes=fread(rnk_file)$V1
target_genes=background_genes[(length(background_genes)-500): length(background_genes)]
```

```{r child="tissue_enrichment.Rmd", eval=FALSE}
```

# Save the session information

```{r}
writeLines(capture.output(sessionInfo()), paste0(prefix, '.sessionInfo.txt'))
```

